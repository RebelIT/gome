---
  - name: Gather vars
    include_vars:
      dir: 'vars'
      extensions: ['yml']

  - name: Compile the application
    shell: "GOOS=linux GOARCH=arm go build -o main ."
    delegate_to: 127.0.0.1

  - name: Make sure config directory exists
    file:
      path: "/etc/gome/"
      state: directory
      mode: 0644
    become: yes

  - name: Copy executable
    copy:
      src: "main"
      dest: "/etc/gome/main"
      mode: a+x

  - name: set application secrets
    template:
      src: roles/application/templates/secrets.json.j2
      dest: "/etc/gome/secrets.json"
    become: yes

  - name: set device file
    template:
      src: roles/application/templates/devices.json.j2
      dest: "/etc/gome/devices.json"
    become: yes
    when: push_blank_device_list

  - name: Make sure service directory exits
    file:
      path: "/usr/lib/systemd/system/"
      state: directory
    become: yes

  - name: Copy Service Files
    template:
      src: "roles/application/templates/gome-server.service"
      dest: "/usr/lib/systemd/system/"
    when: main.stat.exists
    become: yes

  - name: Unleash the daemon (make new service known)
    command: systemctl daemon-reload
    become: yes
    notify:
      - restart gome